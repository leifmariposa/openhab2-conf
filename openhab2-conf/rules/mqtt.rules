var Number prev_ac_setpoint = 0.0

// Test
rule "MQTT Test"
when
  Item mqtt_test received command ON
then
  logInfo('logTime', 'broadlink/tv/samsung/poweron')
  publish("broker", "broadlink/tv/samsung/poweron", "replay")
end


rule "Temperature_rule"
when
  Time cron "0 */10 * ? * *"
  //Item Netatmo_Indoor_Temperature changed
then
  var Number livingroom_temperature = ((Netatmo_Indoor_Temperature.state) as Number).floatValue
  var Number outside_temperature = ((Netatmo_Outdoor_Temperature.state) as Number).floatValue
  var Number livingroom_setpoint = 21.0;
  var Number livingroom_temperature_factor = 2.0
  var Number outside_temperature_factor = 0.05
  var Number ac_setpoint = 0


  ac_setpoint = (livingroom_setpoint + 
                 (22.0 - livingroom_temperature) * livingroom_temperature_factor +
                 (15.0 - outside_temperature) * outside_temperature_factor).intValue;
  /*
               25 =          21.0       +  (22.0 -         20.0         ) * 2.0
               23 =          21.0       +  (22.0 -         21.0         ) * 2.0
               21 =          21.0       +  (22.0 -         22.0         ) * 2.0
               19 =          21.0       +  (22.0 -         23.0         ) * 2.0

  x = (20.0 - outside_temperature) * outside_temperature_factor
  -0.25  = (15.0 - 20.0) * 0.05
   0.0  = (15.0 - 15.0) * 0.05
   0.25  = (15.0 - 10.0) * 0.05
   0.5  = (15.0 -  5.0) * 0.05
   0.75  = (15.0 -  0.0) * 0.05
   1.0  = (15.0 -  -5.0) * 0.05
*/
/*
  if (livingroom_temperature < 19.5) {
    ac_setpoint = 26
  } else if (livingroom_temperature < 20.0) {
    ac_setpoint = 25
  } else if (livingroom_temperature < 20.5) {
    ac_setpoint = 24
  } else if (livingroom_temperature < 21.0) {
    ac_setpoint = 23
  } else if (livingroom_temperature < 21.5) {
    ac_setpoint = 22
  } else if (livingroom_temperature < 22.0) {
    ac_setpoint = 21
  } else if (livingroom_temperature < 22.5) {
    ac_setpoint = 20
  } else if (livingroom_temperature < 23.0) {
    ac_setpoint = 19
  } else {
    ac_setpoint = 18
  }
*/
  logInfo('logTime', 
          'livingroom temperature: ' + livingroom_temperature.toString() + 
          ' outside temperature ' + outside_temperature.toString() + 
          ' ac setpoint: ' + ac_setpoint.toString() + 
          ' prev_ac_setpoint: ' + prev_ac_setpoint.toString())
  if (ac_setpoint != prev_ac_setpoint) {
    logInfo('logTime', 'ac_setpoint changed, sending command to ac')
    prev_ac_setpoint = ac_setpoint
    if (ac_setpoint <= 18) {
      logInfo('logTime', 'sending ac/sharp/heat_auto_18')
      publish("broker", "broadlink/ac/sharp/heat_auto_18", "replay")
    } else if (ac_setpoint <= 19) {
      logInfo('logTime', 'sending ac/sharp/heat_auto_19')
      publish("broker", "broadlink/ac/sharp/heat_auto_19", "replay")
    } else if (ac_setpoint <= 20) {
      logInfo('logTime', 'sending ac/sharp/heat_auto_20')
      publish("broker", "broadlink/ac/sharp/heat_auto_20", "replay")
    } else if (ac_setpoint <= 21) {
      logInfo('logTime', 'sending ac/sharp/heat_auto_21')
      publish("broker", "broadlink/ac/sharp/heat_auto_21", "replay")
    } else if (ac_setpoint <= 22) {
      logInfo('logTime', 'sending ac/sharp/heat_auto_22')
      publish("broker", "broadlink/ac/sharp/heat_auto_22", "replay")
    } else if (ac_setpoint <= 23) {
      logInfo('logTime', 'sending ac/sharp/heat_auto_23')
      publish("broker", "broadlink/ac/sharp/heat_auto_23", "replay")
    } else if (ac_setpoint <= 24) {
      logInfo('logTime', 'sending ac/sharp/heat_auto_24')
      publish("broker", "broadlink/ac/sharp/heat_auto_24", "replay")
    } else if (ac_setpoint <= 25) {
      logInfo('logTime', 'sending ac/sharp/heat_auto_25')
      publish("broker", "broadlink/ac/sharp/heat_auto_25", "replay")
    } else if (ac_setpoint <= 26) {
      logInfo('logTime', 'sending ac/sharp/heat_auto_26')
      publish("broker", "broadlink/ac/sharp/heat_auto_26", "replay")
    }
    TemperatureSetpoint.postUpdate(ac_setpoint)
  }
end

// TV livingroom
rule "TV power on"
when
  Item tv_power_on received command ON
then
  publish("broker", "broadlink/tv/samsung/poweron", "replay")
end

rule "TV power off"
when
  Item tv_power_off received command ON
then
  publish("broker", "broadlink/tv/samsung/poweroff", "replay")
end

rule "TV volume up"
when
  Item tv_volume_up received command ON
then
  publish("broker", "broadlink/tv/samsung/volumeup", "replay")
end

rule "TV volume down"
when
  Item tv_volume_down received command ON
then
  publish("broker", "broadlink/tv/samsung/volumedown", "replay")
end

// LG
rule "LG power"
when
  Item lg_power received command ON
then
  publish("broker", "broadlink/audio/lg/power", "replay")
end

rule "LG volume up"
when
  Item lg_volume_up received command ON
then
  publish("broker", "broadlink/audio/lg/volumeup", "replay")
end

rule "LG volume down"
when
  Item lg_volume_down received command ON
then
  publish("broker", "broadlink/audio/lg/volumedown", "replay")
end
